#!/bin/bash

# ============================================
# Link Rotator - Production Installation Script
# For Hestia Control Panel (Ubuntu/Debian)
# ============================================

set -e

echo "======================================"
echo "Link Rotator - Production Setup"
echo "======================================"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² root
if [ "$EUID" -ne 0 ]; then
   echo "âŒ Please run as root (sudo bash install.sh)"
   exit 1
fi

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
DOMAIN=""
USER=""
PROJECT_PATH=""
ADMIN_EMAIL="adminseo@trafficconnect.com"
ADMIN_PASSWORD=$(openssl rand -base64 12)
JWT_SECRET=$(openssl rand -base64 32)

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
echo "ðŸ“ Enter configuration:"
read -p "Domain (e.g., rotator.example.com): " DOMAIN
read -p "Hestia user (e.g., admin): " USER

if [ -z "$DOMAIN" ] || [ -z "$USER" ]; then
    echo "âŒ Domain and User are required!"
    exit 1
fi

PROJECT_PATH="/home/$USER/web/$DOMAIN/link-rotator"

echo ""
echo "Configuration:"
echo "  Domain: $DOMAIN"
echo "  User: $USER"
echo "  Path: $PROJECT_PATH"
echo ""
read -p "Continue? (y/n): " CONTINUE

if [ "$CONTINUE" != "y" ]; then
    echo "Installation cancelled"
    exit 0
fi

echo ""
echo "======================================"
echo "1. Installing System Dependencies"
echo "======================================"

# Update system
apt-get update

# Install Node.js 20
if ! command -v node &> /dev/null; then
    echo "Installing Node.js 20..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
else
    echo "âœ… Node.js already installed: $(node -v)"
fi

# Install MongoDB 4.4
if ! command -v mongod &> /dev/null; then
    echo "Installing MongoDB 4.4..."

    # Import MongoDB public key
    wget -qO - https://www.mongodb.org/static/pgp/server-4.4.asc | apt-key add -

    # Add MongoDB repository
    echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/4.4 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-4.4.list

    apt-get update
    apt-get install -y mongodb-org

    # Start MongoDB
    systemctl start mongod
    systemctl enable mongod

    echo "âœ… MongoDB installed and started"
else
    echo "âœ… MongoDB already installed"
fi

# Install Redis
if ! command -v redis-server &> /dev/null; then
    echo "Installing Redis..."
    apt-get install -y redis-server

    # Configure Redis
    sed -i 's/^supervised no/supervised systemd/' /etc/redis/redis.conf
    sed -i 's/^# maxmemory <bytes>/maxmemory 256mb/' /etc/redis/redis.conf
    sed -i 's/^# maxmemory-policy noeviction/maxmemory-policy allkeys-lru/' /etc/redis/redis.conf

    systemctl restart redis-server
    systemctl enable redis-server

    echo "âœ… Redis installed and started"
else
    echo "âœ… Redis already installed"
fi

# Install PM2
if ! command -v pm2 &> /dev/null; then
    echo "Installing PM2..."
    npm install -g pm2
    pm2 startup systemd -u $USER --hp /home/$USER
    echo "âœ… PM2 installed"
else
    echo "âœ… PM2 already installed"
fi

echo ""
echo "======================================"
echo "2. Creating Project Structure"
echo "======================================"

# Create project directory
mkdir -p $PROJECT_PATH
cd $PROJECT_PATH

# Clone or copy project files
if [ -d "/tmp/link-rotator-nodejs" ]; then
    echo "Copying project files from /tmp..."
    cp -r /tmp/link-rotator-nodejs/* .
else
    echo "âŒ Please copy project files to /tmp/link-rotator-nodejs first"
    exit 1
fi

# Set ownership
chown -R $USER:$USER $PROJECT_PATH

echo ""
echo "======================================"
echo "3. Installing Node.js Dependencies"
echo "======================================"

# Backend dependencies
sudo -u $USER npm install --production

# Frontend dependencies and build
cd frontend
sudo -u $USER npm install --legacy-peer-deps
sudo -u $USER npm run build
cd ..

echo ""
echo "======================================"
echo "4. Configuring Environment"
echo "======================================"

# Create .env file
cat > .env << EOF
NODE_ENV=production
PORT=3000
MONGODB_URI=mongodb://127.0.0.1:27017/link_rotator
REDIS_URL=redis://127.0.0.1:6379
JWT_SECRET=$JWT_SECRET
ROTATION_CACHE_TTL=3600
EOF

chown $USER:$USER .env

echo "âœ… .env file created"

echo ""
echo "======================================"
echo "5. Initializing Database"
echo "======================================"

# Create MongoDB database and admin user
mongo link_rotator --eval "
db.users.insertOne({
    name: 'Admin',
    email: '$ADMIN_EMAIL',
    password: '\$2b\$10\$rQYPbqVZ8Kx3xZQXZQXZQO7cYqZqZqZqZqZqZqZqZqZqZqZqZqZ',
    role: 'admin',
    isActive: true,
    createdAt: new Date(),
    updatedAt: new Date()
});
"

echo "âœ… Database initialized"

echo ""
echo "======================================"
echo "6. Creating PM2 Process"
echo "======================================"

# Create PM2 ecosystem file
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [{
    name: 'link-rotator',
    script: './src/server.js',
    instances: 2,
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production'
    },
    error_file: './logs/error.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
EOF

chown $USER:$USER ecosystem.config.js

# Create logs directory
mkdir -p logs
chown -R $USER:$USER logs

# Start application with PM2
sudo -u $USER pm2 start ecosystem.config.js
sudo -u $USER pm2 save

echo "âœ… Application started with PM2"

echo ""
echo "======================================"
echo "7. Configuring Nginx"
echo "======================================"

# Create Nginx configuration
NGINX_CONF="/home/$USER/conf/web/$DOMAIN/nginx.conf_link_rotator"

cat > $NGINX_CONF << 'NGINXCONF'
location / {
    root /home/USER/web/DOMAIN/link-rotator/frontend/dist;
    try_files $uri $uri/ /index.html;
}

location /api/ {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
}

location /health {
    proxy_pass http://127.0.0.1:3000;
    access_log off;
}
NGINXCONF

# Replace placeholders
sed -i "s|/home/USER/web/DOMAIN|/home/$USER/web/$DOMAIN|g" $NGINX_CONF

# Include in main Nginx config
MAIN_NGINX="/home/$USER/conf/web/$DOMAIN/nginx.conf"
if ! grep -q "nginx.conf_link_rotator" $MAIN_NGINX; then
    sed -i "/location \/ {/i \    include $NGINX_CONF;" $MAIN_NGINX
fi

# Reload Nginx
systemctl reload nginx

echo "âœ… Nginx configured"

echo ""
echo "======================================"
echo "8. Creating Admin User"
echo "======================================"

# Run admin creation script
cd $PROJECT_PATH
sudo -u $USER node scripts/create-admin.js

echo ""
echo "======================================"
echo "âœ… Installation Complete!"
echo "======================================"
echo ""
echo "ðŸ“‹ Configuration:"
echo "  Domain: https://$DOMAIN"
echo "  Admin Email: $ADMIN_EMAIL"
echo "  Admin Password: $ADMIN_PASSWORD"
echo ""
echo "âš ï¸  IMPORTANT: Save these credentials!"
echo ""
echo "ðŸ“ Next steps:"
echo "  1. Point domain $DOMAIN to this server IP"
echo "  2. Setup SSL in Hestia CP"
echo "  3. Login to https://$DOMAIN"
echo ""
echo "ðŸ”§ Useful commands:"
echo "  pm2 list                    - View running processes"
echo "  pm2 logs link-rotator      - View application logs"
echo "  pm2 restart link-rotator   - Restart application"
echo "  pm2 stop link-rotator      - Stop application"
echo ""
echo "ðŸ“ Project location: $PROJECT_PATH"
echo ""