#!/bin/bash

# ============================================
# Link Rotator - Update Script
# ============================================

set -e

echo "======================================"
echo "Link Rotator - Update"
echo "======================================"
echo ""

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
DOMAIN=""
USER=""

# –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
read -p "Domain: " DOMAIN
read -p "Hestia user: " USER

if [ -z "$DOMAIN" ] || [ -z "$USER" ]; then
    echo "‚ùå Domain and User are required!"
    exit 1
fi

PROJECT_PATH="/home/$USER/web/$DOMAIN/public_html"

if [ ! -d "$PROJECT_PATH" ]; then
    echo "‚ùå Project not found at $PROJECT_PATH"
    exit 1
fi

cd $PROJECT_PATH

echo "1. Creating backup..."
BACKUP_DIR="/home/$USER/backups/link-rotator-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$BACKUP_DIR"
cp -r frontend/dist "$BACKUP_DIR/" 2>/dev/null || echo "No previous build to backup"
cp .env "$BACKUP_DIR/" 2>/dev/null || echo "No .env to backup"
echo "‚úÖ Backup created at $BACKUP_DIR"

echo ""
echo "2. Pulling latest code..."
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Git:
# git pull origin main
echo "‚ö†Ô∏è  Make sure you uploaded the latest code to $PROJECT_PATH"
read -p "Press Enter to continue..."

echo ""
echo "3. Installing backend dependencies..."
sudo -u $USER npm install --production

echo ""
echo "4. Building frontend..."
cd frontend
sudo -u $USER npm install --legacy-peer-deps
sudo -u $USER npm run build
cd ..

echo ""
echo "5. Restarting application..."
sudo -u $USER pm2 restart link-rotator

# Wait for app to start
echo "Waiting for application to start..."
sleep 3

# Check if app is running
if sudo -u $USER pm2 list | grep -q "link-rotator.*online"; then
    echo "‚úÖ Application restarted successfully"
else
    echo "‚ö†Ô∏è  Warning: Application might not be running properly"
    echo "Check logs: pm2 logs link-rotator"
fi

echo ""
echo "‚úÖ Update complete!"
echo ""
echo "üìã Useful commands:"
echo "  pm2 list                    - View running processes"
echo "  pm2 logs link-rotator      - View application logs"
echo "  pm2 restart link-rotator   - Restart application"
echo ""
echo "üìÅ Backup location: $BACKUP_DIR"
echo ""